/*
 * http://github.com/deitch/jstree-grid
 *
 * This plugin handles adding a grid to a tree to display additional data
 *
 * Licensed under the MIT license:
 *   http://www.opensource.org/licenses/mit-license.php
 *
 * Works only with jstree version >= 3.0.0
 *
 * $Date: 2015-11-29 $
 * $Revision:  3.4.2 $
 */
!function(e){"function"==typeof define&&define.amd?define(["jquery","jstree"],e):e(jQuery)}(function(e){var t,i,r,s,d,n=/^\s*$/g,a=/[\\:&!^|()\[\]<>@*'+~#";,= \/${}%]/g,o=function(e){return(e||"").replace(a,"\\$&")},l="data-jstreegrid",h="_DATA_",c=24,p=!1,g="jsgrid_",u="_col",f=10,v=function(e,t){return e.find("div["+l+"='"+t+"']")},m=!1,j=null,_=0,w=0;s=/<\/?[^>]+>/gi,r=function(t,i){var r,s,d,n;return i._gridSettings=i._gridSettings||{},i._gridSettings.indent>0?n=i._gridSettings.indent:(r=e("<div></div>"),s=t.prev("i"),d=s.parent(),r.addClass(i.get_node("#",!0).attr("class")),d.appendTo(r),r.appendTo(e("body")),n=s.width()||c,d.detach(),r.remove(),i._gridSettings.indent=n),n},d=function(e,t){var i,r=e.get_node(t),s=r.children;return i=!s||s.length<=0||!r.state.opened?t:d(e,s[s.length-1])},t=function(e,t){var i,s,d=parseInt(t.settings.grid.columns[0].width,10)+parseInt(t._gridSettings.treeWidthDiff,10);return i=t.get_node(e).parents.length,s=d-i*r(e,t),d},i=function(e,t,i){var r,d="a"===e.get(0).tagName.toLowerCase()?e:e.children("a"),n=i.settings.grid.columns[0];r="",n.title&&(n.title===h?r=i.get_text(t):t.attr(n.title)&&(r=t.attr(n.title))),r=r.replace(s,""),r&&d.attr("title",r)},e.jstree.defaults.grid={width:"auto"},e.jstree.plugins.grid=function(t,r){this._initialize=function(){if(!this._initialized){var t,i,r=this.settings.grid||{},s=this.element,d=s.parent(),n=this._gridSettings={columns:r.columns||[],treeClass:"jstree-grid-col-0",context:r.contextmenu||!1,columnWidth:r.columnWidth,defaultConf:{"*display":"inline","*+display":"inline"},isThemeroller:!!this._data.themeroller,treeWidthDiff:0,resizable:r.resizable,stateful:r.stateful,indent:0},a=n.columns,o=0;for(i=0;i<r.columns.length;i++)if(r.columns[i].tree){o=i;break}this.uniq=Math.ceil(1e3*Math.random()),this.treecol=o,this.rootid=s.attr("id");var l=/msie/.test(navigator.userAgent.toLowerCase());if(l){var h=parseFloat(navigator.appVersion.split("MSIE")[1]);8>h&&(n.defaultConf.display="inline",n.defaultConf.zoom="1")}for(p||(p=!0,t=[".jstree-grid-cell {vertical-align: top; overflow:hidden;margin-left:0;position:relative;width: 100%;padding-left:7px;white-space: nowrap;}",".jstree-grid-cell span {margin-right:0px;margin-right:0px;*display:inline;*+display:inline;white-space: nowrap;}",".jstree-grid-separator {position:absolute; top:0; right:0; height:24px; margin-left: -2px; border-width: 0 2px 0 0; *display:inline; *+display:inline; margin-right:0px;width:0px;}",".jstree-grid-header-cell {overflow: hidden; white-space: nowrap;padding: 1px 3px 2px 5px;}",".jstree-grid-header-themeroller {border: 0; padding: 1px 3px;}",".jstree-grid-header-regular {position:relative; background-color: #EBF3FD;}",".jstree-grid-resizable-separator {cursor: col-resize; width: 2px;}",".jstree-grid-separator-regular {border-color: #d0d0d0; border-style: solid;}",".jstree-grid-cell-themeroller {border: none !important; background: transparent !important;}",".jstree-grid-wrapper {width: 100%; overflow-x: auto;}",".jstree-grid-midwrapper {display: table-row; overflow: visible;}",".jstree-grid-width-auto {width:auto;display:block;}",".jstree-grid-column {display: table-cell; overflow: hidden;}",".jstree-grid-col-0 {width: 100%;}"],e('<style type="text/css">'+t.join("\n")+"</style>").appendTo("head")),this.gridWrapper=e("<div></div>").addClass("jstree-grid-wrapper").appendTo(d),this.midWrapper=e("<div></div>").addClass("jstree-grid-midwrapper").appendTo(this.gridWrapper),r.width&&this.gridWrapper.width(r.width),i=0;i<a.length;i++)e("<div></div>").addClass("jstree-grid-column jstree-grid-column-"+i+" jstree-grid-column-root-"+this.rootid).appendTo(this.midWrapper);this.midWrapper.children("div:eq("+o+")").append(s),s.addClass("jstree-grid-cell"),this._initialized=!0}},this.init=function(e,t){r.init.call(this,e,t),this._initialize()},this.bind=function(){r.bind.call(this),this._initialize(),this.element.on("move_node.jstree create_node.jstree clean_node.jstree change_node.jstree",e.proxy(function(e,t){this.get_node(t||"#",!0);return '',!1},this)).on("delete_node.jstree",e.proxy(function(e,t){if(void 0!==t.node.id){var i,r=this.gridWrapper,s=[t.node.id];for(t.node&&t.node.children_d&&(s=s.concat(t.node.children_d)),i=0;i<s.length;i++)v(r,s[i]).remove()}},this)).on("close_node.jstree",e.proxy(function(e,t){this._hide_grid(t.node)},this)).on("open_node.jstree",e.proxy(function(e,t){},this)).on("load_node.jstree",e.proxy(function(e,t){},this)).on("loaded.jstree",e.proxy(function(e){this._prepare_headers(),this.element.trigger("loaded_grid.jstree")},this)).on("ready.jstree",e.proxy(function(t,i){var r=this.element.find("li a:first").outerHeight();e('<style type="text/css">div.jstree-grid-cell-root-'+this.rootid+" {line-height: "+r+"px}</style>").appendTo("head"),this.gridWrapper.addClass(this.element.attr("class"))},this)).on("move_node.jstree",e.proxy(function(t,i){var r=i.new_instance.element;r.find("li > a").each(e.proxy(function(e,t){},this))},this)).on("hover_node.jstree",e.proxy(function(e,t,i){var r=t.node.id;null!==this._hover_node&&void 0!==this._hover_node&&v(this.gridWrapper,this._hover_node).removeClass("jstree-hovered"),this._hover_node=r,v(this.gridWrapper,r).addClass("jstree-hovered")},this)).on("dehover_node.jstree",e.proxy(function(e,t,i){var r=t.node.id;this._hover_node=null,v(this.gridWrapper,r).removeClass("jstree-hovered")},this)).on("select_node.jstree",e.proxy(function(e,t,i){var r=t.node.id;v(this.gridWrapper,r).addClass("jstree-clicked"),this.get_node(t.node.id,!0).children("div.jstree-grid-cell").addClass("jstree-clicked")},this)).on("deselect_node.jstree",e.proxy(function(e,t,i){var r=t.node.id;v(this.gridWrapper,r).removeClass("jstree-clicked")},this)).on("deselect_all.jstree",e.proxy(function(e,t,i){var r,s=t.node||[];for(r=0;r<s.length;r++)v(this.gridWrapper,s[r]).removeClass("jstree-clicked")},this)).on("search.jstree",e.proxy(function(e,t){var i=this.gridWrapper;return this._data.search.som&&t.nodes.length&&(i.find("div.jstree-grid-cell-regular").hide(),t.nodes.add(t.nodes.parentsUntil(".jstree")).filter(".jstree-node").each(function(e,t){var r=t.id;r&&v(i,r).show()})),!0},this)).on("clear_search.jstree",e.proxy(function(e,t){return this.gridWrapper.find("div.jstree-grid-cell").show(),!0},this)),this._gridSettings.isThemeroller&&this.element.on("select_node.jstree",e.proxy(function(e,t){t.rslt.obj.children("a").nextAll("div").addClass("ui-state-active")},this)).on("deselect_node.jstree deselect_all.jstree",e.proxy(function(e,t){t.rslt.obj.children("a").nextAll("div").removeClass("ui-state-active")},this)).on("hover_node.jstree",e.proxy(function(e,t){t.rslt.obj.children("a").nextAll("div").addClass("ui-state-hover")},this)).on("dehover_node.jstree",e.proxy(function(e,t){t.rslt.obj.children("a").nextAll("div").removeClass("ui-state-hover")},this)),this._gridSettings.stateful&&this.element.on("resize_column.jstree-grid",e.proxy(function(e,t,i){localStorage["jstree-root-"+this.rootid+"-column-"+t]=i},this))},this.teardown=function(){var e=this.gridWrapper,t=this.element,i=e.parent();t.detach(),e.remove(),i.append(t),r.teardown.call(this)},this._clean_grid=function(e,t){var i=this.gridWrapper;e?v(i,t).remove():i.find("div.jstree-grid-cell-regular").remove()},this._prepare_headers=function(){var t,i,r,s,d,n,a,o,l,h,c=this._gridSettings,p=c.columns||[],g=c.columnWidth,u=c.resizable||!1,v=c.isThemeroller,x=v?"themeroller":"regular",y=!1,C=this.gridparent,b=this.rootid,W=c.defaultConf,S=0,z=0;for(this.parent=C,i=0;i<p.length;i++)d=p[i].headerClass||"",n=p[i].columnClass||"",a=p[i].header||"",a&&(y=!0),s=c.stateful&&localStorage["jstree-root-"+b+"-column-"+i]?localStorage["jstree-root-"+b+"-column-"+i]:p[i].width||g,S=v?7:10,"auto"!==s&&"string"!=typeof s&&(s-=S),o=0===i?3:0,r=this.midWrapper.children("div.jstree-grid-column-"+i),l=e("<div></div>").css(W).css({"margin-left":o}).addClass("jstree-grid-div-"+this.uniq+"-"+i+" "+(v?"ui-widget-header ":"")+" jstree-grid-header jstree-grid-header-cell jstree-grid-header-"+x+" "+d+" "+n).html(a),l.addClass((v?"ui-widget-header ":"")+"jstree-grid-header jstree-grid-header-"+x),l.prependTo(r),z+=l.outerWidth(),h=e("<div class='jstree-grid-separator jstree-grid-separator-"+x+(v?" ui-widget-header":"")+(u?" jstree-grid-resizable-separator":"")+"'>&nbsp;</div>").appendTo(l),r.width(s),r.css("min-width",s),r.css("max-width",s);l.addClass((v?"ui-widget-header ":"")+"jstree-grid-header jstree-grid-header-last jstree-grid-header-"+x),void 0===p[p.length-1].width&&(z-=s,r.css({width:"auto"}),l.addClass("jstree-grid-width-auto").next(".jstree-grid-separator").remove()),y?c.header=t:e("div.jstree-grid-header").hide(),!this.bound&&u&&(this.bound=!0,e(document).mouseup(function(){var t,i,r,s,d,n;m&&(n=j.prevAll(".jstree-grid-column").length,d=j.closest(".jstree-grid-wrapper").find(".jstree"),t=e.jstree.reference(d),i=t.settings.grid.columns,s=j.parent().children("div.jstree-grid-column"),(isNaN(n)||0>n)&&(t._gridSettings.treeWidthDiff=d.find("ins:eq(0)").width()+d.find("a:eq(0)").width()-t._gridSettings.columns[0].width),r=t._gridSettings.columns[n].width=parseFloat(j.css("width")),m=!1,j=null,d.trigger("resize_column.jstree-grid",[n,r]))}).mousemove(function(e){if(m){w=e.pageX;var t,i,r,s=w-_;0!==s&&(t=j.width(),i=parseFloat(j.css("width")),i||(i=j.innerWidth()),s=0>s?Math.max(s,-t):s,r=i+s,(s>0||t>0)&&r>f&&(j.width(r+"px"),j.css("min-width",r+"px"),j.css("max-width",r+"px"),_=w))}}),this.gridWrapper.on("selectstart",".jstree-grid-resizable-separator",function(){return!1}).on("mousedown",".jstree-grid-resizable-separator",function(t){return m=!0,_=t.pageX,j=e(this).closest("div.jstree-grid-column"),!1}).on("dblclick",".jstree-grid-resizable-separator",function(t){var i,r,s=e(this),d=s.closest("div.jstree-grid-column"),n=parseFloat(d.css("width")),a=0,o=d.prevAll(".jstree-grid-column").length,l=d.width();d.find(".jstree-grid-cell").each(function(){var t,i=e(this);i.css("position","absolute"),i.css("width","auto"),t=i.outerWidth(),i.css("position","relative"),t>a&&(a=t)}),i=a-n,i=0>i?Math.max(i,-l):i,r=n+i+"px",d.width(r),d.css("min-width",r),d.css("max-width",r),e(this).closest(".jstree-grid-wrapper").find(".jstree").trigger("resize_column.jstree-grid",[o,r])}))},this.redraw_node=function(e,t,i,s){return e=r.redraw_node.call(this,e,t,i,s),e&&this._prepare_grid(e),e},this.refresh=function(){return this._clean_grid(),r.refresh.apply(this,arguments)},this.set_id=function(e,t){var i;e&&(i=e.id);var s=r.set_id.apply(this,arguments);if(s&&void 0!==i){var d,n=this.gridWrapper,a=[i];for(e&&e.children_d&&(a=a.concat(e.children_d)),d=0;d<a.length;d++)v(n,a[d]).attr(l,e.id).attr("id",g+e.id+u+(d+1)).removeClass(g+i+u).addClass(g+e.id+u)}return s},this._hide_grid=function(e){var t,i=e&&e.children_d?e.children_d:[];for(t=0;t<i.length;t++)v(this.gridWrapper,i[t]).remove()},this.holdingCells={},this.getHoldingCells=function(t,i,r){var s,d,n=e(),a=t.children||[];for(d=0;d<a.length;d++)s=g+o(a[d])+u+i,r[s]&&t.state.opened&&(n=n.add(r[s]).add(this.getHoldingCells(this.get_node(a[d]),i,r)));return n},this._edit=function(t,i,r){if(!t)return!1;if(!r)return!1;r=e(r),"div"===r.prop("tagName").toLowerCase()&&(r=r.children("span:first"));var s=this._data.core.rtl,d=this.element.width(),n=t.data[i.value],a=e("<div />",{css:{position:"absolute",top:"-200px",left:s?"0px":"-1000px",visibility:"hidden"}}).appendTo("body"),o=e("<input />",{value:n,"class":"jstree-rename-input",css:{padding:"0",border:"1px solid silver","box-sizing":"border-box",display:"inline-block",height:this._data.core.li_height+"px",lineHeight:this._data.core.li_height+"px",width:"150px"},blur:e.proxy(function(){var e=o.val();""===e||e===n?e=n:(t.data[i.value]=e,this.element.trigger("update_cell.jstree-grid",{node:t,col:i.value,value:e,old:n}),this._prepare_grid(this.get_node(t,!0))),o.remove(),r.show()},this),keydown:function(e){var t=e.which;27===t&&(this.value=n),(27===t||13===t||37===t||38===t||39===t||40===t||32===t)&&e.stopImmediatePropagation(),(27===t||13===t)&&(e.preventDefault(),this.blur())},click:function(e){e.stopImmediatePropagation()},mousedown:function(e){e.stopImmediatePropagation()},keyup:function(e){o.width(Math.min(a.text("pW"+this.value).width(),d))},keypress:function(e){return 13===e.which?!1:void 0}}),l={fontFamily:r.css("fontFamily")||"",fontSize:r.css("fontSize")||"",fontWeight:r.css("fontWeight")||"",fontStyle:r.css("fontStyle")||"",fontStretch:r.css("fontStretch")||"",fontVariant:r.css("fontVariant")||"",letterSpacing:r.css("letterSpacing")||"",wordSpacing:r.css("wordSpacing")||""};r.hide(),r.parent().append(o),o.css(l).width(Math.min(a.text("pW"+o[0].value).width(),d))[0].select()},this._prepare_grid=function(t){var r,a,h,c,p,f,m,j,_,w,x,y,C,b,W,S,z,k,T,A,P,F,V,q,D,L,M,N,I,B=this._gridSettings,H=B.treeClass,E=this,U=B.columns||[],X=B.isThemeroller,$=this.element,Q=this.rootid,Y=X?"themeroller":"regular",G=this.get_node(t),J=B.columnWidth,K=B.defaultConf,O=function(t,i,r,s,d){return function(d){i.children(".jstree-anchor").trigger("click.jstree",d),t.trigger("select_cell.jstree-grid",[{value:r,column:s.header,node:i,grid:e(this),sourceName:s.value}])}},R=function(t,i,r,s,d){return function(t){B.context&&(t.preventDefault(),e.vakata.context.show(this,{x:t.pageX,y:t.pageY},{edit:{label:"Edit",action:function(e){var r=d.get_node(i);E._edit(r,s,t.target)}}}))}},Z=function(e,t){return function(){t.hover_node(e)}},ee=function(e,t){return function(){t.dehover_node(e)}},te=this.midWrapper,ie=G.id,re=this.get_node(G.parent).children,se=jQuery.inArray(ie,re),de=this.holdingCells,ne=!1;if(r=e(t),_=r.children("a"),1===_.length){for(I=!G.state.opened,S=g+o(ie)+u,z="#"===G.parent?null:G.parent,_.addClass(H),i(_,r,E),w=_,c=0;c<U.length;c++)this.treecol!==c&&(D=U[c],N=te.children("div:eq("+c+")"),f=D.cellClass||"",m=D.wideCellClass||"",j=D.columnClass||"",N.addClass(j),p=void 0!==D.value&&null!==D.value?"function"==typeof D.value?D.value(G):null!==G.data&&void 0!==G.data&&void 0!==G.data[D.value]?G.data[D.value]:"":"","function"==typeof D.format&&(p=D.format(p)),D.images?(h=D.images[p]||D.images["default"],h&&(L="*"===h[0]?'<span class="'+h.substr(1)+'"></span>':'<img src="'+h+'">')):L=p,(void 0===L||null===L||n.test(L))&&(L="&nbsp;"),x=D.valueClass&&null!==G.data&&void 0!==G.data?G.data[D.valueClass]||"":"",x&&D.valueClassPrefix&&""!==D.valueClassPrefix&&(x=D.valueClassPrefix+x),y=D.wideValueClass&&null!==G.data&&void 0!==G.data?G.data[D.wideValueClass]||"":"",y&&D.wideValueClassPrefix&&""!==D.wideValueClassPrefix&&(y=D.wideValueClassPrefix+y),W=D.title&&null!==G.data&&void 0!==G.data?G.data[D.title]||"":"",W=W.replace(s,""),b=7,a=D.width||J,"auto"!==a&&(a=M||a-b),w=v(N,ie),(!w||w.length<1)&&(w=e("<div></div>"),e("<span></span>").appendTo(w),w.attr("id",S+c),w.addClass(S),w.attr(l,ie)),A=0>=se?G.parent:d(this,re[se-1]),T=v(N,A),F=se>=re.length-1?"NULL":re[se+1],P=v(N,F),q=G.children&&G.children.length>0?G.children[0]:"NULL",V=v(N,q),k=v(N,z),z?(k&&k.length>0?(T&&T.length>0?w.insertAfter(T):V&&V.length>0?w.insertBefore(V):P&&P.length>0?w.insertBefore(P):w.insertAfter(k),ne=!0):ne=!1,de[S+c]=w):(T&&T.length>0?w.insertAfter(T):V&&V.length>0?w.insertBefore(V):P&&P.length>0?w.insertBefore(P):w.appendTo(N),ne=!0),ne&&w.after(this.getHoldingCells(G,c,de)),C=w.children("span"),C.addClass(f+" "+x).html(L),w=w.css(K).addClass("jstree-grid-cell jstree-grid-cell-regular jstree-grid-cell-root-"+Q+" jstree-grid-cell-"+Y+" "+m+" "+y+(X?" ui-state-default":"")).addClass("jstree-grid-col-"+c),w.click(O($,r,p,D,this)),w.on("contextmenu",R($,r,p,D,this)),w.hover(Z(r,this),ee(r,this)),W&&C.attr("title",W));w.addClass("jstree-grid-cell-last"+(X?" ui-state-default":"")),void 0===U[U.length-1].width&&w.addClass("jstree-grid-width-auto").next(".jstree-grid-separator").remove()}this.element.css({"overflow-y":"auto !important"})},this.holdingCells={}}});